<!DOCTYPE HTML>

<html>
    <head>
        <script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "\/"
        },
        "articleSection" : "blog",
        "name" : "Dự đoán giá chứng khoán SP500 sử dụng LSTM",
        "headline" : "Dự đoán giá chứng khoán SP500 sử dụng LSTM",
        "description" : "Ở bài viết này, chúng ta đề cập bài toán dữ đoán giá chứng khoán.",
        "inLanguage" : "en",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2018",
        "datePublished": "2018-11-10 00:19:00 \x2b0300 \x2b0300",
        "dateModified" : "2018-11-10 00:19:00 \x2b0300 \x2b0300",
        "url" : "\/blog\/2018-11-10-stock-prediction_v1\/",
        "wordCount" : "912",
        "keywords" : [ "Machine learning","Deeplearning","stock prediction","chứng khoán","Blog" ]
    }
    </script>
        
            
                <title>Dự đoán giá chứng khoán SP500 sử dụng LSTM</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        
		<meta name="generator" content="Phạm Duy Tùng" />
        
  
    
  

  

  
  
  
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content='/favicon/mstile.png'>
  <meta name="application-name" content="Phạm Duy Tùng Machine Learning Blog">
  <meta name="msapplication-tooltip" content="Blog ML của Phạm Duy Tùng và Đặng Thị Hằng">
   
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">



        
            <meta name="author" content="Phạm Duy Tùng">
        
        
            <meta name="description" content="Ở bài viết này, chúng ta đề cập bài toán dữ đoán giá chứng khoán.">
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Dự đoán giá chứng khoán SP500 sử dụng LSTM"/>
<meta name="twitter:description" content="Ở bài viết này, chúng ta đề cập bài toán dữ đoán giá chứng khoán."/>
<meta name="twitter:site" content="@example"/>

        <meta property="og:title" content="Dự đoán giá chứng khoán SP500 sử dụng LSTM" />
<meta property="og:description" content="Ở bài viết này, chúng ta đề cập bài toán dữ đoán giá chứng khoán." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/2018-11-10-stock-prediction_v1/" />
<meta property="article:published_time" content="2018-11-10T00:19:00+03:00" />
<meta property="article:modified_time" content="2018-11-10T00:19:00+03:00" />

        <meta property="og:image" content="//images/logo.png">
        <meta property="og:image:type" content="image/png">
        <meta property="og:image:width" content="512">
        <meta property="og:image:height" content="512">
        <meta itemprop="name" content="Dự đoán giá chứng khoán SP500 sử dụng LSTM">
<meta itemprop="description" content="Ở bài viết này, chúng ta đề cập bài toán dữ đoán giá chứng khoán.">
<meta itemprop="datePublished" content="2018-11-10T00:19:00&#43;03:00" />
<meta itemprop="dateModified" content="2018-11-10T00:19:00&#43;03:00" />
<meta itemprop="wordCount" content="912">



<meta itemprop="keywords" content="Machine learning,Deeplearning,stock prediction,chứng khoán," />
        

        
            
        

        
        
          
			
			 <link rel="stylesheet" href="/css/font-awesome.min.css">
			 <link rel="stylesheet" href="/css/bootstrap.min.css">


          
            <link rel="stylesheet" href="/css/academicons.min.css">
        

        
            
                
            
        


  
    
    <link href='//cdn.bootcss.com/highlight.js/9.15.8/styles/github.min.css' rel='stylesheet' type='text/css' />
  


      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-114911596-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

	  
	  <style>
	  
	  body{
font-family: Helvetica,Arial,sans-serif;
}

.card{
	margin-bottom: 10px;
}

#disqus_thread{
padding: 0 5px;
}

.item-header{
padding: 0;
}

.single-content-img{
width: 100%;
    max-height: 450px !important;
    background-size: cover;
    display: block;
    background-position: center;
}

.thumbnail {
    position: relative;
}

.caption {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
	background: rgba(0, 0, 0, 0.25);
	text-align:left;
}

.caption .title{
	font-size: 1.6em;
    line-height: 1.4em;
    top: 0;
	margin-left:20px;
	margin-top:20px;
	
}

.caption .title-caption{
margin-left:10px;
}

#content p{
text-align: justify;
    line-height: 1.9;
    font-size: 12pt;
}

#content img{
	display: block;
    margin-left: auto;
margin-right: auto;
max-width:98%;
}

img + strong {
    font-style: normal;
    display: inherit;
    text-align: center;
}
.img-news{
max-height:150px;
width:100%;
}

.news-tittle{
	padding-top:15px;
	text-align:justify;
}

.author{
	color: orange;
}
.author-inline{
	color: orange;
}

.adv{
height:18px;
}

h1, h2, h3, h4{
padding-bottom: 10px;
    font-weight: bold;
}

h1{
color: #d04764}


h2{
color: orange}

h3{
color: #d04764}

h4{
color: #8dec89}

.hljs{
    white-space: pre-wrap;
    white-space: -moz-pre-wrap;
    white-space: -pre-wrap;
    white-space: -o-pre-wrap;
    word-wrap: break-word;}
	  .titledetail {
    display: block;
    overflow: hidden;
    line-height: 53px;
    font-size: 45px;
    color: #333;
    font-family: 'Roboto Condensed',sans-serif;
    font-weight: 600;
    margin: auto;
	padding:25px 0;
	text-align:justify;
}

.newsrelate {
    display: block;
    overflow: hidden;
	 list-style:none;
}
a ,a:hover{
    text-decoration: none;
}
.newsrelate li {
    float: left;
    overflow: hidden;
    width: 30%;
    margin-left: 2.5%;
    margin-bottom: 15px;
}

.newsrelate li a {
    display: block;
    overflow: hidden;
}

.newsrelate li h3 {
    display: block;
    overflow: hidden;
    line-height: 1.3em;
    font-size: 16pt;
    color: #333;
    line-height: 22px;
    font-weight: 300;
    font-family: Arial,Helvetica,sans-serif;
    width: auto;
    margin: 5px auto;
}

.titlerelate {
    overflow: hidden;
    font-size: 18px;
    font-weight: 600;
    color: #333;
    font-family: 'Roboto Condensed',sans-serif;
    line-height: 32px;
    text-transform: uppercase;
}


	  </style>
	  
    </head>
    <body>
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '1546237302193677',
      xfbml      : true,
      version    : 'v5.0'
    });
    FB.AppEvents.logPageView();
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "https://connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>
<div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v5.0&appId=1853483258232756&autoLogAppEvents=1"></script>
      
      

    
    
<header id="header"  style="background: #790014; color: hsla(0,0%,100%,1);">
<div class="container">
    <nav class="navbar navbar-expand-md navbar-dark">
	
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mr-auto">
            
                <li class="nav-item">
                    <a class='nav-link' href="/blog">
                            <i class="fa fa-home active">&nbsp;</i>Home
                    </a>
                </li>
            
                <li class="nav-item">
                    <a class='nav-link' href="/news/">
                            <i class="fa fa-list">&nbsp;</i>News
                    </a>
                </li>
            
                <li class="nav-item">
                    <a class='nav-link' href="/xem-truyen/">
                            <i class="fa fa-id-card-o">&nbsp;</i>Truyện
                    </a>
                </li>
            
        </ul>
    </nav>
    </div></div>
</header>


   
    
	<div class="container">
	<div class="adv"></div>
	<div>
    <main role="main" >
	
        
        
        <article class="col-md-10 col-lg-9 mx-auto">
  


        
		 <div class="">
            <h3 class="titledetail">Dự đoán giá chứng khoán SP500 sử dụng LSTM</h3>
			
			<div class="col-md-12">
			 
			  <time class="published"
            datetime='2018-11-10'>
            10/11/2018</time>
		 - 
			   <span class="author">Phạm Duy Tùng</span>
			   
			
		<div class="thumbnail text-center">
		 <img class="img-fluid single-content-img lazy" src="../../post_image/sp500_header.png" />
		
			</div>
			 
            
        
       



  

  

  <div id="content" class="col-md-10 mx-auto">
    <h2 id="lời-mở-đầu">Lời mở đầu</h2>
<p>Ở bài viết này, mình sẽ xây dựng mô hình hơn giản để áp dụng vào tập dữ liệu giá chứng khoáng. Mục tiêu của bài này là chúng ta sẽ dự đoán chỉ số S&amp;P 500 sử dụng LSTM. Các bạn có nhu cầu tìm hiểu thêm về chỉ số sp 500 có thể đọc thêm ở <a href="https://vi.wikipedia.org/wiki/S%26P_500">https://vi.wikipedia.org/wiki/S%26P_500</a>. Đây là một ứng dụng nhỏ, không có ý nghĩa nhiều ở thực tế do khi phân tích chứng khoán, ta còn xét thêm rất nhiều yếu tố phụ nữa. Mô hình này thực chất chỉ là một trong những mô hình chơi chơi.</p>
<h2 id="dẫn-nhập">Dẫn nhập</h2>
<h3 id="phân-tích-dữ-liệu">Phân tích dữ liệu</h3>
<p>Các bạn có thể download dữ liệu ở <a href="https://github.com/AlexBlack2202/alexmodel/blob/master/GSPC.csv">https://github.com/AlexBlack2202/alexmodel/blob/master/GSPC.csv</a></p>
<p>Đầu tiên, như thường lệ, chúng ta sẽ import các thư viện cần thiết để sử dụng.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np <span style="color:#75715e"># linear algebra</span>
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd <span style="color:#75715e"># data processing, CSV file I/O (e.g. pd.read_csv)</span>

<span style="color:#f92672">from</span> subprocess <span style="color:#f92672">import</span> check_output
<span style="color:#f92672">from</span> keras.layers.core <span style="color:#f92672">import</span> Dense, Activation, Dropout
<span style="color:#f92672">from</span> keras.layers.recurrent <span style="color:#f92672">import</span> LSTM
<span style="color:#f92672">from</span> keras.models <span style="color:#f92672">import</span> Sequential
<span style="color:#f92672">from</span> sklearn.cross_validation <span style="color:#f92672">import</span>  train_test_split
<span style="color:#f92672">import</span> time <span style="color:#75715e">#helper libraries</span>
<span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> MinMaxScaler
<span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">from</span> numpy <span style="color:#f92672">import</span> newaxis

</code></pre></div><p>Đọc dữ liệu lên:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
file_name <span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">GSPC.csv</span><span style="color:#e6db74">&#39;</span>

prices_dataset <span style="color:#f92672">=</span>  pd<span style="color:#f92672">.</span>read_csv(file_name, header<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)

<span style="color:#e6db74">``</span>

Xem kích thước của dữ liệu:

<span style="color:#e6db74">``</span><span style="color:#960050;background-color:#1e0010">`</span>python
<span style="color:#66d9ef">print</span>(prices_dataset<span style="color:#f92672">.</span>shape)

</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">(<span style="color:#ae81ff">17114</span>, <span style="color:#ae81ff">7</span>)
</code></pre></div><p>Kết quả là ta có  17114 ngàn dòng và 7 cột. Thử show 10 row đầu tiên của dữ liệu lên xem như thế nào.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(prices_dataset<span style="color:#f92672">.</span>head())
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">         Date       Open       High        Low      Close  Adj Close   Volume
<span style="color:#ae81ff">0</span>  <span style="color:#ae81ff">1950</span><span style="color:#f92672">-</span><span style="color:#ae81ff">11</span><span style="color:#f92672">-</span><span style="color:#ae81ff">09</span>  <span style="color:#ae81ff">19.790001</span>  <span style="color:#ae81ff">19.790001</span>  <span style="color:#ae81ff">19.790001</span>  <span style="color:#ae81ff">19.790001</span>  <span style="color:#ae81ff">19.790001</span>  <span style="color:#ae81ff">1760000</span>
<span style="color:#ae81ff">1</span>  <span style="color:#ae81ff">1950</span><span style="color:#f92672">-</span><span style="color:#ae81ff">11</span><span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">19.940001</span>  <span style="color:#ae81ff">19.940001</span>  <span style="color:#ae81ff">19.940001</span>  <span style="color:#ae81ff">19.940001</span>  <span style="color:#ae81ff">19.940001</span>  <span style="color:#ae81ff">1640000</span>
<span style="color:#ae81ff">2</span>  <span style="color:#ae81ff">1950</span><span style="color:#f92672">-</span><span style="color:#ae81ff">11</span><span style="color:#f92672">-</span><span style="color:#ae81ff">13</span>  <span style="color:#ae81ff">20.010000</span>  <span style="color:#ae81ff">20.010000</span>  <span style="color:#ae81ff">20.010000</span>  <span style="color:#ae81ff">20.010000</span>  <span style="color:#ae81ff">20.010000</span>  <span style="color:#ae81ff">1630000</span>
<span style="color:#ae81ff">3</span>  <span style="color:#ae81ff">1950</span><span style="color:#f92672">-</span><span style="color:#ae81ff">11</span><span style="color:#f92672">-</span><span style="color:#ae81ff">14</span>  <span style="color:#ae81ff">19.860001</span>  <span style="color:#ae81ff">19.860001</span>  <span style="color:#ae81ff">19.860001</span>  <span style="color:#ae81ff">19.860001</span>  <span style="color:#ae81ff">19.860001</span>  <span style="color:#ae81ff">1780000</span>
<span style="color:#ae81ff">4</span>  <span style="color:#ae81ff">1950</span><span style="color:#f92672">-</span><span style="color:#ae81ff">11</span><span style="color:#f92672">-</span><span style="color:#ae81ff">15</span>  <span style="color:#ae81ff">19.820000</span>  <span style="color:#ae81ff">19.820000</span>  <span style="color:#ae81ff">19.820000</span>  <span style="color:#ae81ff">19.820000</span>  <span style="color:#ae81ff">19.820000</span>  <span style="color:#ae81ff">1620000</span>

</code></pre></div><p>Cột đầu tiên là ngày, sau đó là giá mở cửa, giá giao dịch cao nhất, giá giao dịch thấp nhât, giá đóng cử, giá đóng cửa đã điều chỉnh, khối lượng giao dịch.</p>
<p>Plot đồ thị của mã SP500 lên:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt

plt<span style="color:#f92672">.</span>plot(prices_dataset<span style="color:#f92672">.</span>Open<span style="color:#f92672">.</span>values, color<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">red</span><span style="color:#e6db74">&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">open</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>plot(prices_dataset<span style="color:#f92672">.</span>Close<span style="color:#f92672">.</span>values, color<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">green</span><span style="color:#e6db74">&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">close</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>plot(prices_dataset<span style="color:#f92672">.</span>Low<span style="color:#f92672">.</span>values, color<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">blue</span><span style="color:#e6db74">&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">low</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>plot(prices_dataset<span style="color:#f92672">.</span>High<span style="color:#f92672">.</span>values, color<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">black</span><span style="color:#e6db74">&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">high</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">stock price</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">time [days]</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">price</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">best</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p><img src="/post_image/sp500indexv1.png" alt="Hình ảnh đừng đồ thị của chỉ số sp 500"></p>
<p>Hình với số lượng hơi nhiều nên khó phân biệt được giá trị của dữ liệu, chúng ta thử show đồ thị của 50 ngày cuối cùng trong dữ liệu.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">prices_dataset_tail_50 <span style="color:#f92672">=</span> prices_dataset<span style="color:#f92672">.</span>tail(<span style="color:#ae81ff">50</span>)

plt<span style="color:#f92672">.</span>plot(prices_dataset_tail_50<span style="color:#f92672">.</span>Open<span style="color:#f92672">.</span>values, color<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">red</span><span style="color:#e6db74">&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">open</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>plot(prices_dataset_tail_50<span style="color:#f92672">.</span>Close<span style="color:#f92672">.</span>values, color<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">green</span><span style="color:#e6db74">&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">close</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>plot(prices_dataset_tail_50<span style="color:#f92672">.</span>Low<span style="color:#f92672">.</span>values, color<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">blue</span><span style="color:#e6db74">&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">low</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>plot(prices_dataset_tail_50<span style="color:#f92672">.</span>High<span style="color:#f92672">.</span>values, color<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">black</span><span style="color:#e6db74">&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">high</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">stock price</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">time [days]</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">price</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">best</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>show()

</code></pre></div><p><img src="/post_image/sp500index_tail_50.png" alt="Hình ảnh đừng đồ thị của chỉ số sp 500"></p>
<p>Hình ảnh trông khá rõ ràng và trực quan hơn rất nhiều.</p>
<p>Chúng ta sẽ bỏ đi cột DATE,Adj Close,Volume đi. Các cột đó không cần thiết cho quá trình dự đoán.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
prices_dataset_dropout <span style="color:#f92672">=</span> prices_dataset<span style="color:#f92672">.</span>drop([<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Date</span><span style="color:#e6db74">&#39;</span>,<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Adj Close</span><span style="color:#e6db74">&#39;</span>,<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Volume</span><span style="color:#e6db74">&#39;</span>], <span style="color:#ae81ff">1</span>)
</code></pre></div><h3 id="scale-dữ-liệu">Scale dữ liệu</h3>
<p>Khi sử dụng ANN, chúng ta thông thường sẽ scale dữ liệu input về đoạn [-1,1]. Trong python, thư viện sklearn đã hỗ trợ cho chúng ta sẵn các hàm scale dữ liệu cần thiết.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Scale data</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">normalize_data</span>(df):
   min_max_scaler <span style="color:#f92672">=</span> MinMaxScaler()
   df[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Open</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> min_max_scaler<span style="color:#f92672">.</span>fit_transform(df<span style="color:#f92672">.</span>Open<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>))
   df[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">High</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> min_max_scaler<span style="color:#f92672">.</span>fit_transform(df<span style="color:#f92672">.</span>High<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>))
   df[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Low</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> min_max_scaler<span style="color:#f92672">.</span>fit_transform(df<span style="color:#f92672">.</span>Low<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>))
   df[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">Close</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> min_max_scaler<span style="color:#f92672">.</span>fit_transform(df<span style="color:#f92672">.</span>Close<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>))
   <span style="color:#66d9ef">return</span> df

prices_dataset_norm <span style="color:#f92672">=</span> normalize_data(prices_dataset_dropout)
</code></pre></div><h3 id="phân-chia-tập-train-và-test">Phân chia tập train và test.</h3>
<p>Chúng ta sẽ chia dữ liệu thành 2 phần với 80% là train và 20% còn lại là test. Chọn seq_len=20, các bạn có thể test với các seq len khác, và sau đó chuyển dữ liệu về dạng numpy array để dễ dàng thực hiện các phép chuyển đổi.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_data</span>(stock_ds, seq_len):
   data_raw <span style="color:#f92672">=</span> stock_ds<span style="color:#f92672">.</span>as_matrix()
   data <span style="color:#f92672">=</span> []
   
   <span style="color:#75715e"># create all possible sequences of length seq_len</span>
   <span style="color:#66d9ef">for</span> index <span style="color:#f92672">in</span> range(len(data_raw) <span style="color:#f92672">-</span> seq_len): 
       data<span style="color:#f92672">.</span>append(data_raw[index: index <span style="color:#f92672">+</span> seq_len])
   <span style="color:#66d9ef">return</span> data

<span style="color:#75715e">#data as numpy array</span>
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">generate_train_test</span>(data_ds,split_percent<span style="color:#f92672">=</span><span style="color:#ae81ff">0.8</span>):
   <span style="color:#66d9ef">print</span>(len(data_ds))
   data <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>asarray(data_ds)
  
   data_size <span style="color:#f92672">=</span> len(data)
   train_end <span style="color:#f92672">=</span> int(np<span style="color:#f92672">.</span>floor(split_percent<span style="color:#f92672">*</span>data_size))
   
   x_train <span style="color:#f92672">=</span> data[:train_end,:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,:]
   y_train <span style="color:#f92672">=</span> data[:train_end,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,:]
   

   
   x_test <span style="color:#f92672">=</span> data[train_end:,:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,:]
   y_test <span style="color:#f92672">=</span> data[train_end:,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,:]
   
   <span style="color:#66d9ef">return</span> [x_train, y_train, x_test, y_test]



seq_len <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span> <span style="color:#75715e"># choose sequence length</span>

seq_prices_dataset <span style="color:#f92672">=</span> generate_data(prices_dataset_norm,seq_len)

x_train, y_train, x_test, y_test <span style="color:#f92672">=</span> generate_train_test(seq_prices_dataset, <span style="color:#ae81ff">0.8</span>)

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">x_train.shape = </span><span style="color:#e6db74">&#39;</span>,x_train<span style="color:#f92672">.</span>shape)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">y_train.shape = </span><span style="color:#e6db74">&#39;</span>, y_train<span style="color:#f92672">.</span>shape)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">x_test.shape = </span><span style="color:#e6db74">&#39;</span>, x_test<span style="color:#f92672">.</span>shape)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">y_test.shape = </span><span style="color:#e6db74">&#39;</span>,y_test<span style="color:#f92672">.</span>shape)
</code></pre></div><p>Kết quả:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">x_train<span style="color:#f92672">.</span>shape <span style="color:#f92672">=</span>  (<span style="color:#ae81ff">13675</span>, <span style="color:#ae81ff">19</span>, <span style="color:#ae81ff">4</span>)
y_train<span style="color:#f92672">.</span>shape <span style="color:#f92672">=</span>  (<span style="color:#ae81ff">13675</span>, <span style="color:#ae81ff">4</span>)
x_test<span style="color:#f92672">.</span>shape <span style="color:#f92672">=</span>  (<span style="color:#ae81ff">3419</span>, <span style="color:#ae81ff">19</span>, <span style="color:#ae81ff">4</span>)
y_test<span style="color:#f92672">.</span>shape <span style="color:#f92672">=</span>  (<span style="color:#ae81ff">3419</span>, <span style="color:#ae81ff">4</span>)
</code></pre></div><h3 id="xây-dựng-mô-hình-sử-dụng-keras">Xây dựng mô hình sử dụng keras</h3>
<p>Ở đây mình sử dụng keras xây dựng mô hình ANN. Mô hình của mình xây dựng gồm:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">model <span style="color:#f92672">=</span> Sequential()

model<span style="color:#f92672">.</span>add(LSTM(
   input_dim<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>,
   output_dim<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>,
   return_sequences<span style="color:#f92672">=</span>True))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.2</span>))

model<span style="color:#f92672">.</span>add(LSTM(
   <span style="color:#ae81ff">100</span>,
   return_sequences<span style="color:#f92672">=</span>False))
model<span style="color:#f92672">.</span>add(Dropout(<span style="color:#ae81ff">0.2</span>))

model<span style="color:#f92672">.</span>add(Dense(
   output_dim<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>))
model<span style="color:#f92672">.</span>add(Activation(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">linear</span><span style="color:#e6db74">&#39;</span>))



model<span style="color:#f92672">.</span>compile(loss<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">mean_squared_error</span><span style="color:#e6db74">&#39;</span>, optimizer<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">adam</span><span style="color:#e6db74">&#39;</span>, metrics<span style="color:#f92672">=</span>[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">accuracy</span><span style="color:#e6db74">&#39;</span>])
checkpoint <span style="color:#f92672">=</span> ModelCheckpoint(filepath<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">my_model_stock.h5</span><span style="color:#e6db74">&#39;</span>, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, save_best_only<span style="color:#f92672">=</span>True)
hist <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>fit(x_train, y_train, epochs<span style="color:#f92672">=</span><span style="color:#ae81ff">300</span>, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">128</span>, verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, callbacks<span style="color:#f92672">=</span>[checkpoint], validation_split<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>)
</code></pre></div><p>Sau một thời gian chạy, mình cũng thu được model. Các bạn quan tâm có thể download model của mình huấn luyện được tại <a href="https://drive.google.com/open?id=1ImHQM9yWmOjpF5tjmSI9oqAi5BORa9Rs">https://drive.google.com/open?id=1ImHQM9yWmOjpF5tjmSI9oqAi5BORa9Rs</a> . Tiến hành plot dữ liệu tập test lên xem kết quả như thế nào.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
model <span style="color:#f92672">=</span>load_model(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">sp500_stockperdict.h5</span><span style="color:#e6db74">&#39;</span>)


y_hat <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(x_test)

ft <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 0 = open, 1 = highest, 2 =lowest , 3 = close</span>

plt<span style="color:#f92672">.</span>plot( y_test[:,ft], color<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">blue</span><span style="color:#e6db74">&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">target</span><span style="color:#e6db74">&#39;</span>)

plt<span style="color:#f92672">.</span>plot( y_hat[:,ft], color<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">red</span><span style="color:#e6db74">&#39;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">prediction</span><span style="color:#e6db74">&#39;</span>)

plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">future stock prices</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">time [days]</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">normalized price</span><span style="color:#e6db74">&#39;</span>)
plt<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">best</span><span style="color:#e6db74">&#39;</span>)

plt<span style="color:#f92672">.</span>show()

<span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> mean_squared_error

<span style="color:#75715e"># 0 = open, 1 = highest, 2 =lowest , 3 = close</span>
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">open error: </span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">print</span>(mean_squared_error(y_test[:,<span style="color:#ae81ff">0</span>], y_hat[ :,<span style="color:#ae81ff">0</span>]))

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">highest error: </span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">print</span>(mean_squared_error(y_test[:,<span style="color:#ae81ff">1</span>], y_hat[ :,<span style="color:#ae81ff">1</span>]))

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">lowest error: </span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">print</span>(mean_squared_error(y_test[:,<span style="color:#ae81ff">2</span>], y_hat[ :,<span style="color:#ae81ff">2</span>]))

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">close error: </span><span style="color:#e6db74">&#34;</span>)
<span style="color:#66d9ef">print</span>(mean_squared_error(y_test[:,<span style="color:#ae81ff">3</span>], y_hat[ :,<span style="color:#ae81ff">3</span>]))
</code></pre></div><p><img src="/post_image/sp500index_predict.png" alt="hình chứng khoán"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">open error:
<span style="color:#ae81ff">0.0009739211460315127</span>
highest error:
<span style="color:#ae81ff">0.0010539412808401607</span>
lowest error:
<span style="color:#ae81ff">0.0010066509540756113</span>
close error:
<span style="color:#ae81ff">0.0010840500965408758</span>
</code></pre></div><p>Kết quả của mô hình trông khá tốt, về hình dạng thì khá tương đồng với kết quả. Chúng ta có thể cải tiến model bằng cách nâng số lượng layter/ hidden node.</p>
<p>Cảm ơn các bạn đã theo dõi. Hẹn gặp bạn ở các bài viết tiếp theo.</p>

  </div>
  
			</div>
  <footer class="col-md-10  mx-auto">
  <div >
  <div class="fb-like" data-share="true"  data-width="450"  data-show-faces="true">
</div> </p></div>
    <ul class="stats list-unstyled">
 
    
  <li class="tags">
    <ul class="list-inline">
       
            
            
                <i class="fa fa-tags"></i>
                
                
                <li class="list-inline-item"><a class="article-category-link" href="/tags/machine-learning">Machine learning</a></li>
                
                
                <li class="list-inline-item"><a class="article-category-link" href="/tags/deeplearning">Deeplearning</a></li>
                
                
                <li class="list-inline-item"><a class="article-category-link" href="/tags/stock-prediction">stock prediction</a></li>
                
                
                <li class="list-inline-item"><a class="article-category-link" href="/tags/ch%E1%BB%A9ng-kho%C3%A1n">chứng khoán</a></li>
                
            
        
    </ul>
  </li>
  
</ul>

	</div>
  </footer>
  <hr/>
<div class="titlerelate">Bài viết khác</div>
<div class="infinite-container featured-task">
<div class="card-deck card-break infinite-item">



    
        <div class="card">
		<a href="/blog/2018-11-03-stock-prediction/"
                class="button big previous">
		
		<img class="card-img-top lazy" src="../../post_image/stock_finance_chart.png" width="100" />
		<div class="card-body">
		<h5 class="card-title">
		Dự đoán chứng khoán sử dụng tensorflow
				</h5>
				</div>
				</a>
				</div>
    

    
        <div class="card">
		<a href="/blog/2018-11-13-instacart-market-basket-analysis/"
                class="button big previous">
		
		<img class="card-img-top lazy" src="http://tradecircle.com.vn/wp-content/uploads/2018/10/instacart.jpg" width="100" />
		
		<div class="card-body">
		<h5 class="card-title">
		Phân tích giỏ hàng của website instacart
				</h5>
				</div>
				</a>
				</div>
    

</div>
</div>



<div class="fb-comments" data-href="" data-width="" data-numposts="5"></div>

    <article class="post">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "phamduytung" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </article>



</article>


		
    </main>
    
	</div>
	</div>
    
	<hr>
  <footer class="footer">
  <div class="container text-center">
    
    <p class="copyright">
      
        &copy; 2019
        
          Phạm Duy Tùng Machine Learning Blog
        
      
     
    </p>
	</div>
  </footer>
    
    

    
      
    

    
      
      
      
        <script src="//cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>
        
        
        
        <script src="//cdn.bootcss.com/highlight.js/9.15.8/languages/python.min.js"></script>
        <script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>
      
    
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js"></script>
     

   <script src="/js/jquery-3.3.1.min.js"></script>
   
    <script src="/js/bootstrap.min.js"></script>
      <script src="/js/util.js"></script>
      <script src="/js/main.js"></script>
     
    

    
      
        
      
    
	
    
    <script>hljs.initHighlightingOnLoad();</script>
      
<script async
src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


	  
	  
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-114911596-1"  data-cfasync="false"></script>
<script  data-cfasync="false">
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-114911596-1');
</script>
<script src="https://cdn.jsdelivr.net/npm/intersection-observer@0.5.1/intersection-observer.js"  data-cfasync="false"></script>
<script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@12.0.0/dist/lazyload.min.js"  data-cfasync="false"></script>
	   <script  type="text/javascript"  data-cfasync="false">

  function getcontent(){
 

   

             var myLazyLoad = new LazyLoad({
    elements_selector: ".lazy"
});
                }
            
			
			$(document).ready(function(){
			getcontent();
			}); 
</script>

  </body>
</html>

