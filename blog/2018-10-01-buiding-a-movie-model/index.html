<!DOCTYPE HTML>

<html>

    <head>
	<script src="https://www.googleoptimize.com/optimize.js?id=OPT-52RT2BV"></script>
        <script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "\/"
        },
        "articleSection" : "blog",
        "name" : "Xây dựng chương trình gợi ý phim dựa vào tập dữ liệu movie len",
        "headline" : "Xây dựng chương trình gợi ý phim dựa vào tập dữ liệu movie len",
        "description" : "Ở bài viết này, tôi sẽ tập trung vào vào sử dụng implement Alternating Least Saqures của Collaborative Filtering trong thư viện Spark MLlib trên tập dữ liệu movieLens.",
        "inLanguage" : "en",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2018",
        "datePublished": "2018-10-01 00:19:00 \x2b0300 \x2b0300",
        "dateModified" : "2018-10-01 00:19:00 \x2b0300 \x2b0300",
        "url" : "\/blog\/2018-10-01-buiding-a-movie-model\/",
        "wordCount" : "1788",
        "keywords" : [ "Machine learning","Deeplearning","Spark","Blog" ]
    }
    </script>
        
            
                <title>Xây dựng chương trình gợi ý phim dựa vào tập dữ liệu movie len</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        
		<meta name="generator" content="Phạm Duy Tùng" />
        
  
    
  

  

  
  
  
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content='/favicon/mstile.png'>
  <meta name="application-name" content="Phạm Duy Tùng Machine Learning Blog">
  <meta name="msapplication-tooltip" content="Blog ML của Phạm Duy Tùng và Đặng Thị Hằng">
   
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">



        
        
            <meta name="description" content="Ở bài viết này, tôi sẽ tập trung vào vào sử dụng implement Alternating Least Saqures của Collaborative Filtering trong thư viện Spark MLlib trên tập dữ liệu movieLens.">
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Xây dựng chương trình gợi ý phim dựa vào tập dữ liệu movie len"/>
<meta name="twitter:description" content="Ở bài viết này, tôi sẽ tập trung vào vào sử dụng implement Alternating Least Saqures của Collaborative Filtering trong thư viện Spark MLlib trên tập dữ liệu movieLens."/>
<meta name="twitter:site" content="@example"/>

        <meta property="og:title" content="Xây dựng chương trình gợi ý phim dựa vào tập dữ liệu movie len" />
<meta property="og:description" content="Ở bài viết này, tôi sẽ tập trung vào vào sử dụng implement Alternating Least Saqures của Collaborative Filtering trong thư viện Spark MLlib trên tập dữ liệu movieLens." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/2018-10-01-buiding-a-movie-model/" />
<meta property="article:published_time" content="2018-10-01T00:19:00+03:00" />
<meta property="article:modified_time" content="2018-10-01T00:19:00+03:00" />

        <meta property="og:image" content="//images/logo.png">
        <meta property="og:image:type" content="image/png">
        <meta property="og:image:width" content="512">
        <meta property="og:image:height" content="512">
        <meta itemprop="name" content="Xây dựng chương trình gợi ý phim dựa vào tập dữ liệu movie len">
<meta itemprop="description" content="Ở bài viết này, tôi sẽ tập trung vào vào sử dụng implement Alternating Least Saqures của Collaborative Filtering trong thư viện Spark MLlib trên tập dữ liệu movieLens.">
<meta itemprop="datePublished" content="2018-10-01T00:19:00&#43;03:00" />
<meta itemprop="dateModified" content="2018-10-01T00:19:00&#43;03:00" />
<meta itemprop="wordCount" content="1788">



<meta itemprop="keywords" content="Machine learning,Deeplearning,Spark," />
        

        
            
        

        
        
          
			
			 <link rel="stylesheet" href="/css/font-awesome.min.css">
			 <link rel="stylesheet" href="/css/bootstrap.min.css">


          
            <link rel="stylesheet" href="/css/academicons.min.css">
        

        
            
                
            
        


  
    
    <link href='//cdn.bootcss.com/highlight.js/9.15.8/styles/xcode.min.css' rel='stylesheet' type='text/css' />
  


      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-114911596-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

	    <link rel="stylesheet" href="/css/jquery.amlich.css">
	  <style>
	  
	  body{
font-family: Helvetica,Arial,sans-serif;
}

.card{
	margin-bottom: 10px;
}

#disqus_thread{
padding: 0 5px;
}

.item-header{
padding: 0;
}

.single-content-img{
width: 100%;
    max-height: 450px !important;
    background-size: cover;
    display: block;
    background-position: center;
}

.thumbnail {
    position: relative;
}

.caption {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
	background: rgba(0, 0, 0, 0.25);
	text-align:left;
}

.caption .title{
	font-size: 1.6em;
    line-height: 1.4em;
    top: 0;
	margin-left:20px;
	margin-top:20px;
	
}

.caption .title-caption{
margin-left:10px;
}

#content p{
text-align: justify;
    font-size: 16px;
    color: #333;
    line-height: 28px;
}

#content img{
	display: block;
    margin-left: auto;
margin-right: auto;
max-width:98%;
}

img + strong {
    font-style: normal;
    display: inherit;
    text-align: center;
}
.img-news{
max-height:150px;
width:100%;
}

.news-tittle{
	padding-top:15px;
	text-align:justify;
}

.author{
	color: orange;
}
.author-inline{
	color: orange;
}

.adv{
height:18px;
}


.hljs{
    white-space: pre-wrap;
    white-space: -moz-pre-wrap;
    white-space: -pre-wrap;
    white-space: -o-pre-wrap;
    word-wrap: break-word;}
.titledetail {
    display: block;
    overflow: hidden;
    line-height: 53px;
    font-size: 45px;
    font-family: 'Roboto Condensed',sans-serif;
    font-weight: 600;
    width: 800px;
    margin: auto;
	padding: 0 ;
}

.newsrelate {
    display: block;
    overflow: hidden;
	 list-style:none;
}
a ,a:hover{
    text-decoration: none;
}
.newsrelate li {
    float: left;
    overflow: hidden;
    width: 30%;
    margin-left: 2.5%;
    margin-bottom: 15px;
}

.newsrelate li a {
    display: block;
    overflow: hidden;
}

.userdetail {
    display: block;
    overflow: hidden;
    margin: 0 10px 0 0;
    padding: 15px 0;
}
.newsrelate li h3 {
    display: block;
    overflow: hidden;
    line-height: 1.3em;
    font-size: 16pt;
    line-height: 22px;
    font-weight: 300;
    font-family: Arial,Helvetica,sans-serif;
    width: auto;
    margin: 5px auto;
}

.titlerelate {
    overflow: hidden;
    font-size: 18px;
    font-weight: 600;
    font-family: 'Roboto Condensed',sans-serif;
    line-height: 32px;
    text-transform: uppercase;
}
article .captionnews {
    color: #999;
    font-size: 14px;
    font-style: italic;
    padding: 10px;
    text-align: center;
    margin-bottom: 15px;
}

.bgtrans h1 {
    display: block;
    overflow: hidden;
    font-size: 45px;
    line-height: 55px;
    color: #fff;
    width: 800px;
    margin: auto;
    position: absolute;
    left: 0;
    right: 0;
    bottom: 50px;
    font-family: 'Roboto Condensed',sans-serif;
    font-weight: 600;
}

.bgcover {
    display: block;
    overflow: hidden;
    height: 450px;
    background: no-repeat center center;
    -webkit-background-size: cover;
    -moz-background-size: cover;
    -o-background-size: cover;
    background-size: cover;
    position: relative;
    margin-bottom: -65px;
}
.bgcover .bgtrans .userdetail {
    width: 800px;
    margin: auto;
    position: absolute;
    left: 0;
    right: 0;
    bottom: 10px;
}
.userdetail {
    display: block;
    overflow: hidden;
    margin: 0 10px 0 0;
    padding: 15px 0;
}
	  </style>

<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-P62ZZPB');</script>


<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P62ZZPB"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

    </head>
    <body>
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '1546237302193677',
      xfbml      : true,
      version    : 'v5.0'
    });
    FB.AppEvents.logPageView();
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "https://connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>
<div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/vi_VN/sdk.js#xfbml=1&version=v5.0&appId=1853483258232756&autoLogAppEvents=1"></script>
      
      

    
    
<header id="header"  style="background: #790014; color: hsla(0,0%,100%,1);">
<div class="container">
    <nav class="navbar navbar-expand-md navbar-dark">
	
	<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav mr-auto">
            
                <li class="nav-item">
                    <a class='nav-link' href="/blog">
                            <i class="fa fa-home active">&nbsp;</i>Home
                    </a>
                </li>
            
                <li class="nav-item">
                    <a class='nav-link' href="/news/">
                            <i class="fa fa-list">&nbsp;</i>News
                    </a>
                </li>
            
                <li class="nav-item">
                    <a class='nav-link' href="/xem-truyen/">
                            <i class="fa fa-id-card-o">&nbsp;</i>Truyện
                    </a>
                </li>
            
        </ul>
    </nav>
    </div></div>
</header>


   
    
	<div class="container-fluid">
	<div class="adv"></div>
	
    <main role="main" >
	
        
        
        <article>
  


        
		 <div class="header">
           
			
			
			
		<div class="bgcover" style="background-image:url(../../post_image/AlexNet-1.png)" >
		<div class="bgtrans">
		 <h1 class="titledetail">Xây dựng chương trình gợi ý phim dựa vào tập dữ liệu movie len</h1>
		<div class="userdetail">
			 
			  <time class="published" style="color: #fff;"
            datetime='2018-10-01'>
            01/10/2018</time>
		 - 
			   <span class="author"></span>
			   
			</div>
		
			</div>
			</div>
			
			<div style="padding-top:80px;"></div>
			</div>
			 
            
        
       



  

  
 
  <div id="content"  class="col-md-8 col-lg-9 mx-auto" style="box-shadow: 0 0 50px 0 rgba(0,0,0,.15);padding:20px;">
    <h2 id="lời-mở-đầu">Lời mở đầu</h2>
<p>MovieLens là một tập dữ liệu được sử dụng rộng rãi cách đây nhiều năm. Hôm nay, mình sẽ sử dụng tập dữ liệu này và mô hình ALS của spark để xây dựng chương trình dự đoán phim cho người dùng.</p>
<h2 id="chuẩn-bị-dữ-liệu">Chuẩn bị dữ liệu</h2>
<p>Các bạn có thể download tập dữ liệu MovieLens ở link <a href="https://grouplens.org/datasets/movielens/">https://grouplens.org/datasets/movielens/</a>. Các bạn có thể download trực tiếp 2 file nén ở link <a href="http://files.grouplens.org/datasets/movielens/ml-latest-small.zip">http://files.grouplens.org/datasets/movielens/ml-latest-small.zip</a> và link  <a href="http://files.grouplens.org/datasets/movielens/ml-latest.zip">http://files.grouplens.org/datasets/movielens/ml-latest.zip</a>.</p>
<p>Ở trên bao gồm 2 tập dữ liệu. chúng ta tạo thư mục datasets và download rồi bỏ chúng vào trong thư mục đấy.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">complete_dataset_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://files.grouplens.org/datasets/movielens/ml-latest.zip&#39;</span>
small_dataset_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://files.grouplens.org/datasets/movielens/ml-latest-small.zip&#39;</span>

<span style="color:#f92672">import</span> os

datasets_path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;datasets&#39;</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(datasets_path):
    os<span style="color:#f92672">.</span>makedirs(datasets_path))

complete_dataset_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datasets_path, <span style="color:#e6db74">&#39;ml-latest.zip&#39;</span>)
small_dataset_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datasets_path, <span style="color:#e6db74">&#39;ml-latest-small.zip&#39;</span>)

<span style="color:#f92672">import</span> urllib
<span style="color:#f92672">import</span> zipfile

<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(small_dataset_url):
	small_f <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>urlretrieve (small_dataset_url, small_dataset_path)<span style="color:#75715e">#Download</span>
	<span style="color:#66d9ef">with</span> zipfile<span style="color:#f92672">.</span>ZipFile(small_dataset_path, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> z:<span style="color:#75715e">#Giải nén</span>
		z<span style="color:#f92672">.</span>extractall(datasets_path)
<span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>exists(small_dataset_url):
	complete_f <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>urlretrieve (complete_dataset_url, complete_dataset_path)<span style="color:#75715e">#Download</span>
	<span style="color:#66d9ef">with</span> zipfile<span style="color:#f92672">.</span>ZipFile(complete_dataset_path, <span style="color:#e6db74">&#34;r&#34;</span>) <span style="color:#66d9ef">as</span> z:<span style="color:#75715e">#Giải nén</span>
		z<span style="color:#f92672">.</span>extractall(datasets_path)

</code></pre></div><p>Trong thư mục giải nén, chúng ta sẽ có các file ratings.csv, movies.csv, tags.csv, links.csv, README.txt.</p>
<h2 id="loading-và-parsing-dữ-liệu">Loading và parsing dữ liệu.</h2>
<p>Mỗi dòng trong tập ratings.csv có định dạng <code>&quot;userId,movieId,rating,timestamp&quot;</code>.</p>
<p>Mỗi dòng trong tập movies.csv có định dạng <code>&quot;movieId,title,genres&quot;</code>.</p>
<p>Mỗi dòng trong tập tags.csv có định dạng <code>&quot;userId,movieId,tag,timestamp&quot;</code>.</p>
<p>Mỗi dòng trong tập links.csv có định dạng <code>&quot;movieId,imdbId,tmdbId&quot;</code>.</p>
<p>Tóm lại, các trường dữ liệu trong các file csv đều ngăn cách nhau bởi dấu phẩy (,). Trong python, ta có thể dùng hàm split để cắt chúng ra. Sau đó sẽ load toàn bộ dữ liệu lên RDDs.</p>
<p>Lưu ý nhỏ:</p>
<ul>
<li>Ở tập dữ liệu ratings, chúng ta chỉ giữ lại các trường <code>(UserID, MovieID, Rating)</code> bỏ đi trường timestamp vì không cần thiết.</li>
<li>Ở tập dữ liệu movies  chúng ta giữ lại trường <code>(MovieID, Title)</code> và bỏ đi trường genres vì lý do tương tự.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">small_ratings_file <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datasets_path, <span style="color:#e6db74">&#39;ml-latest-small&#39;</span>, <span style="color:#e6db74">&#39;ratings.csv&#39;</span>)
small_ratings_raw_data <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>textFile(small_ratings_file)
small_ratings_raw_data_header <span style="color:#f92672">=</span> small_ratings_raw_data<span style="color:#f92672">.</span>take(<span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">0</span>]
small_ratings_data <span style="color:#f92672">=</span> small_ratings_raw_data<span style="color:#f92672">.</span>filter(<span style="color:#66d9ef">lambda</span> line: line<span style="color:#f92672">!=</span>small_ratings_raw_data_header)<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> line: line<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;,&#34;</span>))<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> tokens: (tokens[<span style="color:#ae81ff">0</span>],tokens[<span style="color:#ae81ff">1</span>],tokens[<span style="color:#ae81ff">2</span>]))<span style="color:#f92672">.</span>cache()
<span style="color:#66d9ef">print</span>(small_ratings_data<span style="color:#f92672">.</span>take(<span style="color:#ae81ff">3</span>)) <span style="color:#75715e">#Hiện thị top 3 ratting đầu tiên</span>

small_movies_file <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datasets_path, <span style="color:#e6db74">&#39;ml-latest-small&#39;</span>, <span style="color:#e6db74">&#39;movies.csv&#39;</span>)

small_movies_raw_data <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>textFile(small_movies_file)
small_movies_raw_data_header <span style="color:#f92672">=</span> small_movies_raw_data<span style="color:#f92672">.</span>take(<span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">0</span>]

small_movies_data <span style="color:#f92672">=</span> small_movies_raw_data<span style="color:#f92672">.</span>filter(<span style="color:#66d9ef">lambda</span> line: line<span style="color:#f92672">!=</span>small_movies_raw_data_header)\
    <span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> line: line<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;,&#34;</span>))<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> tokens: (tokens[<span style="color:#ae81ff">0</span>],tokens[<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">.</span>cache()
    
small_movies_data<span style="color:#f92672">.</span>take(<span style="color:#ae81ff">3</span>) <span style="color:#75715e">#Hiện thị top 3 movie đầu tiên</span>
</code></pre></div><p>Phần tiếp theo, chúng ta sẽ tìm hiểu lọc cộng tác (Collaborative Filtering) và cách sử dụng Spark MLlib để xây dựng mô hình dự báo.</p>
<h2 id="collaborative-filtering">Collaborative Filtering</h2>
<p>Ở đây, tôi sẽ không đề cập đến lọc cộng tác là gì, các bạn có nhu cầu tìm hiểu có thể xem ở bài post khác hoặc tham khảo trên wiki. Chúng ta sẽ tập trung vào tìm hiểu cách sử dụng ALS trong thư viện MLlib của Spark. Các tham số của thuật toán này bao gồm:</p>
<ul>
<li>
<p>numBlocks: số lượng block được sử dụng trong tính toán song song (-1 với ý nghĩa là auto configure).</p>
</li>
<li>
<p>rank: số lượng nhân tố ẩn (latent factor) trong mô hình.</p>
</li>
<li>
<p>iterations: số lần lặp.</p>
</li>
<li>
<p>lambda: tham số của chuẩn hoá(regularization ) trong ALS.</p>
</li>
<li>
<p>implicitPrefs specifies whether to use the explicit feedback ALS variant or one adapted for implicit feedback data.</p>
</li>
<li>
<p>alpha is a parameter applicable to the implicit feedback variant of ALS that governs the baseline confidence in preference observations.</p>
</li>
</ul>
<h2 id="chọn-các-tham-số-cho-als">Chọn các tham số cho ALS</h2>
<p>Để chọn được các tham số tốt nhất cho mô hình ALS, chúng ta sẽ sử dụng tập small để grid search. Đầu tiên, chúng ta chia tập dữ liệu thành 3 phần là tập train, tập vali và  tập test. Sau đó tiến hành huấn luyện trên tập train và predict trên tập valid để tìm được tham số tốt nhất. Cuối cùng đánh giá kết quả đạt được trên tập test.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">training_RDD, validation_RDD, test_RDD <span style="color:#f92672">=</span> small_ratings_data<span style="color:#f92672">.</span>randomSplit([<span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>], seed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
validation_for_predict_RDD <span style="color:#f92672">=</span> validation_RDD<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> x: (x[<span style="color:#ae81ff">0</span>], x[<span style="color:#ae81ff">1</span>]))
test_for_predict_RDD <span style="color:#f92672">=</span> test_RDD<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> x: (x[<span style="color:#ae81ff">0</span>], x[<span style="color:#ae81ff">1</span>]))

<span style="color:#f92672">from</span> pyspark.mllib.recommendation <span style="color:#f92672">import</span> ALS
<span style="color:#f92672">import</span> math

seed <span style="color:#f92672">=</span> <span style="color:#ae81ff">5L</span>
iterations <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
regularization_parameter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>
ranks <span style="color:#f92672">=</span> [<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">12</span>]
errors <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>]
err <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
tolerance <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.02</span>

min_error <span style="color:#f92672">=</span> float(<span style="color:#e6db74">&#39;inf&#39;</span>)
best_rank <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
best_iteration <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">for</span> rank <span style="color:#f92672">in</span> ranks:
    model <span style="color:#f92672">=</span> ALS<span style="color:#f92672">.</span>train(training_RDD, rank, seed<span style="color:#f92672">=</span>seed, iterations<span style="color:#f92672">=</span>iterations,
                      lambda_<span style="color:#f92672">=</span>regularization_parameter)
    predictions <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predictAll(validation_for_predict_RDD)<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> r: ((r[<span style="color:#ae81ff">0</span>], r[<span style="color:#ae81ff">1</span>]), r[<span style="color:#ae81ff">2</span>]))
    rates_and_preds <span style="color:#f92672">=</span> validation_RDD<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> r: ((int(r[<span style="color:#ae81ff">0</span>]), int(r[<span style="color:#ae81ff">1</span>])), float(r[<span style="color:#ae81ff">2</span>])))<span style="color:#f92672">.</span>join(predictions)
    error <span style="color:#f92672">=</span> math<span style="color:#f92672">.</span>sqrt(rates_and_preds<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> r: (r[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> r[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">1</span>])<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>mean())
    errors[err] <span style="color:#f92672">=</span> error
    err <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;For rank </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> the RMSE is </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> (rank, error))
    <span style="color:#66d9ef">if</span> error <span style="color:#f92672">&lt;</span> min_error:
        min_error <span style="color:#f92672">=</span> error
        best_rank <span style="color:#f92672">=</span> rank

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;The best model was trained with rank </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> best_rank)
</code></pre></div><p>Kết quả sau khi thực hiện đoạn code trên là:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">For rank <span style="color:#ae81ff">4</span> the RMSE <span style="color:#f92672">is</span> <span style="color:#ae81ff">0.963681878574</span>
For rank <span style="color:#ae81ff">8</span> the RMSE <span style="color:#f92672">is</span> <span style="color:#ae81ff">0.96250475933</span>
For rank <span style="color:#ae81ff">12</span> the RMSE <span style="color:#f92672">is</span> <span style="color:#ae81ff">0.971647563632</span>
The best model was trained <span style="color:#66d9ef">with</span> rank <span style="color:#ae81ff">8</span>
</code></pre></div><p>Tiến hành thực hiện test.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">model_test <span style="color:#f92672">=</span> ALS<span style="color:#f92672">.</span>train(training_RDD, best_rank, seed<span style="color:#f92672">=</span>seed, iterations<span style="color:#f92672">=</span>iterations,
                      lambda_<span style="color:#f92672">=</span>regularization_parameter)
predictions <span style="color:#f92672">=</span> model_test<span style="color:#f92672">.</span>predictAll(test_for_predict_RDD)<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> r: ((r[<span style="color:#ae81ff">0</span>], r[<span style="color:#ae81ff">1</span>]), r[<span style="color:#ae81ff">2</span>]))
rates_and_preds <span style="color:#f92672">=</span> test_RDD<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> r: ((int(r[<span style="color:#ae81ff">0</span>]), int(r[<span style="color:#ae81ff">1</span>])), float(r[<span style="color:#ae81ff">2</span>])))<span style="color:#f92672">.</span>join(predictions)
error <span style="color:#f92672">=</span> math<span style="color:#f92672">.</span>sqrt(rates_and_preds<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> r: (r[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> r[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">1</span>])<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>mean())
    
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;For testing data the RMSE is </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> (error))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">For testing data the RMSE <span style="color:#f92672">is</span> <span style="color:#ae81ff">0.972342381898</span>
</code></pre></div><p>Xem kỹ hơn một chút về dữ liệu mà spark trả về cho chúng ta. Với predictions và rates_and_preds, ta có:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">print</span>(predictions<span style="color:#f92672">.</span>take(<span style="color:#ae81ff">3</span>))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">[((<span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">4018</span>), <span style="color:#ae81ff">3.280114696166238</span>),
 ((<span style="color:#ae81ff">375</span>, <span style="color:#ae81ff">4018</span>), <span style="color:#ae81ff">2.7365714977314086</span>),
 ((<span style="color:#ae81ff">674</span>, <span style="color:#ae81ff">4018</span>), <span style="color:#ae81ff">2.510684514310653</span>)]
</code></pre></div><p>Tập dữ liệu trả về bao gồm cặp <code>(UserID, MovieID)</code> và <code>Rating</code> (tương ứng với colum 0, column 1 và column 2 ở trên),được hiểu ở đây là với người dùng UserID và phim MovieID thì mô hình sẽ dự đoán người dùng sẽ rating kết quả Rating.</p>
<p>Sau đó chúng ta sẽ nối(join) chúng với tập valid tương ứng theo cặp <code>(UserID, MovieID)</code>, kết quả đạt được là:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">rates_and_preds<span style="color:#f92672">.</span>take(<span style="color:#ae81ff">3</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">[((<span style="color:#ae81ff">558</span>, <span style="color:#ae81ff">788</span>), (<span style="color:#ae81ff">3.0</span>, <span style="color:#ae81ff">3.0419325487471403</span>)),
 ((<span style="color:#ae81ff">176</span>, <span style="color:#ae81ff">3550</span>), (<span style="color:#ae81ff">4.5</span>, <span style="color:#ae81ff">3.3214065001580986</span>)),
 ((<span style="color:#ae81ff">302</span>, <span style="color:#ae81ff">3908</span>), (<span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">2.4728711204440765</span>))]
</code></pre></div><p>Việc còn lại là chúng ta sẽ tính trung bình độ lỗi bằng hàm <code>mean()</code> và <code>sqlt()</code>.</p>
<h2 id="xây-dựng-mô-hình-với-tập-dữ-liệu-large">Xây dựng mô hình với tập dữ liệu large</h2>
<p>Tiếp theo, chúng ta sẽ sử dụng tập dự liệu bự hơn để xây dựng mô hình. Cách thực hiện y chang như tập dữ liệu nhỏ đã được trình bày ở trên, nên tôi sẽ bỏ qua một số giải thích không cần thiết để tránh lặp lại.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Load the complete dataset file</span>
complete_ratings_file <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datasets_path, <span style="color:#e6db74">&#39;ml-latest&#39;</span>, <span style="color:#e6db74">&#39;ratings.csv&#39;</span>)
complete_ratings_raw_data <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>textFile(complete_ratings_file)
complete_ratings_raw_data_header <span style="color:#f92672">=</span> complete_ratings_raw_data<span style="color:#f92672">.</span>take(<span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">0</span>]

<span style="color:#75715e"># Parse</span>
complete_ratings_data <span style="color:#f92672">=</span> complete_ratings_raw_data<span style="color:#f92672">.</span>filter(<span style="color:#66d9ef">lambda</span> line: line<span style="color:#f92672">!=</span>complete_ratings_raw_data_header)\
    <span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> line: line<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;,&#34;</span>))<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> tokens: (int(tokens[<span style="color:#ae81ff">0</span>]),int(tokens[<span style="color:#ae81ff">1</span>]),float(tokens[<span style="color:#ae81ff">2</span>])))<span style="color:#f92672">.</span>cache()
    
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;There are </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> recommendations in the complete dataset&#34;</span> <span style="color:#f92672">%</span> (complete_ratings_data<span style="color:#f92672">.</span>count()))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">There are <span style="color:#ae81ff">21063128</span> recommendations <span style="color:#f92672">in</span> the complete dataset
</code></pre></div><p>Tiến hành train và test.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">training_RDD, test_RDD <span style="color:#f92672">=</span> complete_ratings_data<span style="color:#f92672">.</span>randomSplit([<span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">3</span>], seed<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)

complete_model <span style="color:#f92672">=</span> ALS<span style="color:#f92672">.</span>train(training_RDD, best_rank, seed<span style="color:#f92672">=</span>seed,iterations<span style="color:#f92672">=</span>iterations, lambda_<span style="color:#f92672">=</span>regularization_parameter)

test_for_predict_RDD <span style="color:#f92672">=</span> test_RDD<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> x: (x[<span style="color:#ae81ff">0</span>], x[<span style="color:#ae81ff">1</span>]))

predictions <span style="color:#f92672">=</span> complete_model<span style="color:#f92672">.</span>predictAll(test_for_predict_RDD)<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> r: ((r[<span style="color:#ae81ff">0</span>], r[<span style="color:#ae81ff">1</span>]), r[<span style="color:#ae81ff">2</span>]))
rates_and_preds <span style="color:#f92672">=</span> test_RDD<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> r: ((int(r[<span style="color:#ae81ff">0</span>]), int(r[<span style="color:#ae81ff">1</span>])), float(r[<span style="color:#ae81ff">2</span>])))<span style="color:#f92672">.</span>join(predictions)
error <span style="color:#f92672">=</span> math<span style="color:#f92672">.</span>sqrt(rates_and_preds<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> r: (r[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> r[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">1</span>])<span style="color:#f92672">**</span><span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>mean())
    
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;For testing data the RMSE is </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> (error))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">For testing data the RMSE <span style="color:#f92672">is</span> <span style="color:#ae81ff">0.82183583368</span>
</code></pre></div><h3 id="xây-dựng-mô-hình-dự-đoán-phim">Xây dựng mô hình dự đoán phim</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">complete_movies_file <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(datasets_path, <span style="color:#e6db74">&#39;ml-latest&#39;</span>, <span style="color:#e6db74">&#39;movies.csv&#39;</span>)
complete_movies_raw_data <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>textFile(complete_movies_file)
complete_movies_raw_data_header <span style="color:#f92672">=</span> complete_movies_raw_data<span style="color:#f92672">.</span>take(<span style="color:#ae81ff">1</span>)[<span style="color:#ae81ff">0</span>]

<span style="color:#75715e"># Parse</span>
complete_movies_data <span style="color:#f92672">=</span> complete_movies_raw_data<span style="color:#f92672">.</span>filter(<span style="color:#66d9ef">lambda</span> line: line<span style="color:#f92672">!=</span>complete_movies_raw_data_header)\
    <span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> line: line<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;,&#34;</span>))<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> tokens: (int(tokens[<span style="color:#ae81ff">0</span>]),tokens[<span style="color:#ae81ff">1</span>],tokens[<span style="color:#ae81ff">2</span>]))<span style="color:#f92672">.</span>cache()

complete_movies_titles <span style="color:#f92672">=</span> complete_movies_data<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> x: (int(x[<span style="color:#ae81ff">0</span>]),x[<span style="color:#ae81ff">1</span>]))
    
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;There are </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> movies in the complete dataset&#34;</span> <span style="color:#f92672">%</span> (complete_movies_titles<span style="color:#f92672">.</span>count()))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">There are <span style="color:#ae81ff">27303</span> movies <span style="color:#f92672">in</span> the complete dataset
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_counts_and_averages</span>(ID_and_ratings_tuple):
    nratings <span style="color:#f92672">=</span> len(ID_and_ratings_tuple[<span style="color:#ae81ff">1</span>])
    <span style="color:#66d9ef">return</span> ID_and_ratings_tuple[<span style="color:#ae81ff">0</span>], (nratings, float(sum(x <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> ID_and_ratings_tuple[<span style="color:#ae81ff">1</span>]))<span style="color:#f92672">/</span>nratings)

movie_ID_with_ratings_RDD <span style="color:#f92672">=</span> (complete_ratings_data<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> x: (x[<span style="color:#ae81ff">1</span>], x[<span style="color:#ae81ff">2</span>]))<span style="color:#f92672">.</span>groupByKey())
movie_ID_with_avg_ratings_RDD <span style="color:#f92672">=</span> movie_ID_with_ratings_RDD<span style="color:#f92672">.</span>map(get_counts_and_averages)
movie_rating_counts_RDD <span style="color:#f92672">=</span> movie_ID_with_avg_ratings_RDD<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> x: (x[<span style="color:#ae81ff">0</span>], x[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>]))
</code></pre></div><p>Giả sử chúng ta có 1 người dùng mới, với các ratting như sau:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">new_user_ID <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>

<span style="color:#75715e"># The format of each line is (userID, movieID, rating)</span>
new_user_ratings <span style="color:#f92672">=</span> [
     (<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">260</span>,<span style="color:#ae81ff">4</span>), <span style="color:#75715e"># Star Wars (1977)</span>
     (<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">3</span>), <span style="color:#75715e"># Toy Story (1995)</span>
     (<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">16</span>,<span style="color:#ae81ff">3</span>), <span style="color:#75715e"># Casino (1995)</span>
     (<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">25</span>,<span style="color:#ae81ff">4</span>), <span style="color:#75715e"># Leaving Las Vegas (1995)</span>
     (<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">32</span>,<span style="color:#ae81ff">4</span>), <span style="color:#75715e"># Twelve Monkeys (a.k.a. 12 Monkeys) (1995)</span>
     (<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">335</span>,<span style="color:#ae81ff">1</span>), <span style="color:#75715e"># Flintstones, The (1994)</span>
     (<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">379</span>,<span style="color:#ae81ff">1</span>), <span style="color:#75715e"># Timecop (1994)</span>
     (<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">296</span>,<span style="color:#ae81ff">3</span>), <span style="color:#75715e"># Pulp Fiction (1994)</span>
     (<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">858</span>,<span style="color:#ae81ff">5</span>) , <span style="color:#75715e"># Godfather, The (1972)</span>
     (<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">50</span>,<span style="color:#ae81ff">4</span>) <span style="color:#75715e"># Usual Suspects, The (1995)</span>
    ]
new_user_ratings_RDD <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>parallelize(new_user_ratings)
<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;New user ratings: </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> new_user_ratings_RDD<span style="color:#f92672">.</span>take(<span style="color:#ae81ff">10</span>))
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">New user ratings: [(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">260</span>, <span style="color:#ae81ff">9</span>), (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">8</span>), (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">7</span>), (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">8</span>), (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">9</span>), (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">335</span>, <span style="color:#ae81ff">4</span>), (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">379</span>, <span style="color:#ae81ff">3</span>), (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">296</span>, <span style="color:#ae81ff">7</span>), (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">858</span>, <span style="color:#ae81ff">10</span>), (<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">8</span>)]
</code></pre></div><p>Chúng ta tiến hành huấn luyện lại mô hình khi có thêm người mới:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">complete_data_with_new_ratings_RDD <span style="color:#f92672">=</span> complete_ratings_data<span style="color:#f92672">.</span>union(new_user_ratings_RDD)

<span style="color:#f92672">from</span> time <span style="color:#f92672">import</span> time

t0 <span style="color:#f92672">=</span> time()
new_ratings_model <span style="color:#f92672">=</span> ALS<span style="color:#f92672">.</span>train(complete_data_with_new_ratings_RDD, best_rank, seed<span style="color:#f92672">=</span>seed, 
                              iterations<span style="color:#f92672">=</span>iterations, lambda_<span style="color:#f92672">=</span>regularization_parameter)
tt <span style="color:#f92672">=</span> time() <span style="color:#f92672">-</span> t0

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;New model trained in </span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> seconds&#34;</span> <span style="color:#f92672">%</span> round(tt,<span style="color:#ae81ff">3</span>))

</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">New model trained <span style="color:#f92672">in</span> <span style="color:#ae81ff">56.61</span> seconds
</code></pre></div><p>Tiến hành dự đoán ratting của người dùng mới cho toàn bộ các phim người dùng đó chưa xem.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">new_user_ratings_ids <span style="color:#f92672">=</span> map(<span style="color:#66d9ef">lambda</span> x: x[<span style="color:#ae81ff">1</span>], new_user_ratings) <span style="color:#75715e"># get just movie IDs</span>
<span style="color:#75715e"># keep just those not on the ID list (thanks Lei Li for spotting the error!)</span>
new_user_unrated_movies_RDD <span style="color:#f92672">=</span> (complete_movies_data<span style="color:#f92672">.</span>filter(<span style="color:#66d9ef">lambda</span> x: x[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> new_user_ratings_ids)<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> x: (new_user_ID, x[<span style="color:#ae81ff">0</span>])))

<span style="color:#75715e"># Use the input RDD, new_user_unrated_movies_RDD, with new_ratings_model.predictAll() to predict new ratings for the movies</span>
new_user_recommendations_RDD <span style="color:#f92672">=</span> new_ratings_model<span style="color:#f92672">.</span>predictAll(new_user_unrated_movies_RDD)
</code></pre></div><p>Và show ra top 3 kết quả :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Transform new_user_recommendations_RDD into pairs of the form (Movie ID, Predicted Rating)</span>
new_user_recommendations_rating_RDD <span style="color:#f92672">=</span> new_user_recommendations_RDD<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> x: (x<span style="color:#f92672">.</span>product, x<span style="color:#f92672">.</span>rating))
new_user_recommendations_rating_title_and_count_RDD <span style="color:#f92672">=</span> \
    new_user_recommendations_rating_RDD<span style="color:#f92672">.</span>join(complete_movies_titles)<span style="color:#f92672">.</span>join(movie_rating_counts_RDD)
new_user_recommendations_rating_title_and_count_RDD<span style="color:#f92672">.</span>take(<span style="color:#ae81ff">3</span>)
</code></pre></div><p>Hiển thị top recommend (Ở đây sẽ flat dữ liệu hiển thị thành dàng <code>((Title, Rating, Ratings Count))</code> ra cho dễ nhìn).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">new_user_recommendations_rating_title_and_count_RDD <span style="color:#f92672">=</span> new_user_recommendations_rating_title_and_count_RDD<span style="color:#f92672">.</span>map(<span style="color:#66d9ef">lambda</span> r: (r[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">1</span>], r[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>], r[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">1</span>]))

top_movies <span style="color:#f92672">=</span> new_user_recommendations_rating_title_and_count_RDD<span style="color:#f92672">.</span>filter(<span style="color:#66d9ef">lambda</span> r: r[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">&gt;=</span><span style="color:#ae81ff">25</span>)<span style="color:#f92672">.</span>takeOrdered(<span style="color:#ae81ff">25</span>, key<span style="color:#f92672">=</span><span style="color:#66d9ef">lambda</span> x: <span style="color:#f92672">-</span>x[<span style="color:#ae81ff">1</span>])

<span style="color:#66d9ef">print</span> (<span style="color:#e6db74">&#39;TOP recommended movies (with more than 25 reviews):</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span>
        <span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(map(str, top_movies)))

</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">TOP recommended movies (<span style="color:#66d9ef">with</span> more than <span style="color:#ae81ff">25</span> reviews):
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#34;Godfather: Part II&#39;</span>, <span style="color:#ae81ff">8.503749129186701</span>, <span style="color:#ae81ff">29198</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#34;Civil War&#39;</span>, <span style="color:#ae81ff">8.386497469089297</span>, <span style="color:#ae81ff">257</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Frozen Planet (2011)&#39;</span>, <span style="color:#ae81ff">8.372705479107108</span>, <span style="color:#ae81ff">31</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;&#34;Shawshank Redemption&#39;</span>, <span style="color:#ae81ff">8.258510064442426</span>, <span style="color:#ae81ff">67741</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Cosmos (1980)&#39;</span>, <span style="color:#ae81ff">8.252254825768972</span>, <span style="color:#ae81ff">948</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Band of Brothers (2001)&#39;</span>, <span style="color:#ae81ff">8.225114960311624</span>, <span style="color:#ae81ff">4450</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Generation Kill (2008)&#39;</span>, <span style="color:#ae81ff">8.206487040524653</span>, <span style="color:#ae81ff">52</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#34;Schindler&#39;s List (1993)&#34;</span>, <span style="color:#ae81ff">8.172761674773625</span>, <span style="color:#ae81ff">53609</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Dr. Strangelove or: How I Learned to Stop Worrying and Love the Bomb (1964)&#39;</span>, <span style="color:#ae81ff">8.166229786764168</span>, <span style="color:#ae81ff">23915</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#34;One Flew Over the Cuckoo&#39;s Nest (1975)&#34;</span>, <span style="color:#ae81ff">8.15617022970577</span>, <span style="color:#ae81ff">32948</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Casablanca (1942)&#39;</span>, <span style="color:#ae81ff">8.141303207981174</span>, <span style="color:#ae81ff">26114</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Seven Samurai (Shichinin no samurai) (1954)&#39;</span>, <span style="color:#ae81ff">8.139633165142612</span>, <span style="color:#ae81ff">11796</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Goodfellas (1990)&#39;</span>, <span style="color:#ae81ff">8.12931139039048</span>, <span style="color:#ae81ff">27123</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Star Wars: Episode V - The Empire Strikes Back (1980)&#39;</span>, <span style="color:#ae81ff">8.124225700242096</span>, <span style="color:#ae81ff">47710</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Jazz (2001)&#39;</span>, <span style="color:#ae81ff">8.078538221315313</span>, <span style="color:#ae81ff">25</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#34;Long Night&#39;s Journey Into Day (2000)&#34;</span>, <span style="color:#ae81ff">8.050176820606127</span>, <span style="color:#ae81ff">34</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Lawrence of Arabia (1962)&#39;</span>, <span style="color:#ae81ff">8.041331489948814</span>, <span style="color:#ae81ff">13452</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Raiders of the Lost Ark (Indiana Jones and the Raiders of the Lost Ark) (1981)&#39;</span>, <span style="color:#ae81ff">8.0399424815528</span>, <span style="color:#ae81ff">45908</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;12 Angry Men (1957)&#39;</span>, <span style="color:#ae81ff">8.011389274280754</span>, <span style="color:#ae81ff">13235</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#34;It&#39;s Such a Beautiful Day (2012)&#34;</span>, <span style="color:#ae81ff">8.007734839026181</span>, <span style="color:#ae81ff">35</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Apocalypse Now (1979)&#39;</span>, <span style="color:#ae81ff">8.005094327199552</span>, <span style="color:#ae81ff">23905</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Paths of Glory (1957)&#39;</span>, <span style="color:#ae81ff">7.999379786394267</span>, <span style="color:#ae81ff">3598</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Rear Window (1954)&#39;</span>, <span style="color:#ae81ff">7.9860865203540214</span>, <span style="color:#ae81ff">17996</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;State of Play (2003)&#39;</span>, <span style="color:#ae81ff">7.981582126801772</span>, <span style="color:#ae81ff">27</span>)
    (<span style="color:#e6db74">u</span><span style="color:#e6db74">&#39;Chinatown (1974)&#39;</span>, <span style="color:#ae81ff">7.978673289692703</span>, <span style="color:#ae81ff">16195</span>)
</code></pre></div><h2 id="dự-đoán-rating-của-1-cá-nhân">Dự đoán rating của 1 cá nhân</h2>
<p>Một trường hợp khác là chúng ta cần dự đoán giá trị ratting của 1 người dùng với 1 bộ phim cụ thể nào đó.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">my_movie <span style="color:#f92672">=</span> sc<span style="color:#f92672">.</span>parallelize([(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">500</span>)]) <span style="color:#75715e"># Quiz Show (1994)</span>
individual_movie_rating_RDD <span style="color:#f92672">=</span> new_ratings_model<span style="color:#f92672">.</span>predictAll(new_user_unrated_movies_RDD)
individual_movie_rating_RDD<span style="color:#f92672">.</span>take(<span style="color:#ae81ff">1</span>)
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">[Rating(user<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, product<span style="color:#f92672">=</span><span style="color:#ae81ff">122880</span>, rating<span style="color:#f92672">=</span><span style="color:#ae81ff">4.955831875971526</span>)]
</code></pre></div><h2 id="lưu-trữ-mô-hình">Lưu trữ mô hình</h2>
<p>Sau khi có được mô hình. Chúng ta cần phải lưu trữ chúng lại để sau này dùng.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pyspark.mllib.recommendation <span style="color:#f92672">import</span> MatrixFactorizationModel

model_path <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>join(<span style="color:#e6db74">&#39;models&#39;</span>, <span style="color:#e6db74">&#39;movie_lens_als&#39;</span>)

<span style="color:#75715e"># Save and load model</span>
model<span style="color:#f92672">.</span>save(sc, model_path)
same_model <span style="color:#f92672">=</span> MatrixFactorizationModel<span style="color:#f92672">.</span>load(sc, model_path)

</code></pre></div>
  </div>
  
			</div>
  <footer class="col-md-10  mx-auto">
  <div >
  <div class="fb-like" data-share="true"  data-width="450"  data-show-faces="true">
</div> </p></div>
    <ul class="stats list-unstyled">
 
    
  <li class="tags">
    <ul class="list-inline">
       
            
            
                <i class="fa fa-tags"></i>
                
                
                <li class="list-inline-item"><a class="article-category-link" href="/tags/machine-learning">Machine learning</a></li>
                
                
                <li class="list-inline-item"><a class="article-category-link" href="/tags/deeplearning">Deeplearning</a></li>
                
                
                <li class="list-inline-item"><a class="article-category-link" href="/tags/spark">Spark</a></li>
                
            
        
    </ul>
  </li>
  
</ul>

	</div>
  </footer>
  <hr/>
<div class="infinite-container featured-task col-md-8 mx-auto">
<div class="titlerelate">Bài viết khác</div>

<div class="card-deck card-break infinite-item">



    
        <div class="card  col-md-6" style="padding-top:15px;">
		<a href="/blog/2018-06-15-understanding-alexnet/"
                class="button big previous">
		
		<img class="card-img-top lazy" src="../../post_image/AlexNet-1.png" width="100" />
		<div class="card-body">
		<h5 class="card-title">
		Tìm hiểu về mạng neural network AlexNet
				</h5>
				</div>
				</a>
				</div>
    

    
        <div class="card  col-md-6"  style="padding-top:15px;">
		<a href="/blog/2018-10-02-understanding-epoch-batchsize-iterations/"
                class="button big previous">
		
		<img class="card-img-top lazy" src="../../post_image/epoch_batchsize_iteration.png" width="100" />
		
		<div class="card-body">
		<h5 class="card-title">
		Phân biệt Epoch - Batch size và Iterations
				</h5>
				</div>
				</a>
				</div>
    

</div>
</div>



<div class="fb-comments" data-href="" data-width="" data-numposts="5"></div>

    <article class="post">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "phamduytung" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </article>



</article>


		
    </main>
    
	
	</div>
    
	<hr>
  <footer class="footer">
  <div class="container text-center">
    
    <p class="copyright">
      
        &copy; 2020
        
          Phạm Duy Tùng Machine Learning Blog
        
      
     
    </p>
	</div>
  </footer>
    
    

    
      
    

    
      
      
      
        <script src="//cdn.bootcss.com/highlight.js/9.15.8/highlight.min.js"></script>
        
        
        
        <script src="//cdn.bootcss.com/highlight.js/9.15.8/languages/python.min.js"></script>
        <script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>
      
    
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js"></script>
     

   <script src="/js/jquery-2.2.4.min.js"></script>
   
    <script src="/js/bootstrap.min.js"></script>
      <script src="/js/util.js"></script>
      <script src="/js/main.js"></script>
     
    

    
      
        
      
    
	
    
    
      
<script async
src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


	  
	  
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-114911596-1"  data-cfasync="false"></script>
<script  data-cfasync="false">
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-114911596-1');
</script>
<script src="https://cdn.jsdelivr.net/npm/intersection-observer@0.5.1/intersection-observer.js"  data-cfasync="false"></script>
<script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@12.0.0/dist/lazyload.min.js"  data-cfasync="false"></script>
 <script  src="/js/jquery.amlich.js" data-cfasync="false" ></script>
	   <script  type="text/javascript"  data-cfasync="false">

  function getcontent(){
 

   

             var myLazyLoad = new LazyLoad({
    elements_selector: ".lazy"
});
                }
            
			
			$(document).ready(function(){
      getcontent();
      $('#calander').amLich({
  type: 'calendar', 
  tableWidth: '100%' 
});
  

			}); 
</script>
 

  </body>
</html>

